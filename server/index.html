<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="static/lib/codemirror.css">
    <script src="static/js/moment.js"></script>
    <script src="static/lib/codemirror.js"></script>
    <script src="static/addon/edit/matchbrackets.js"></script>
    <script src="static/mode/sparql/sparql.js"></script>
    <script src="static/mode/python/python.js"></script>
    <!--Import Google Icon Font-->
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="static/css/materialize.min.css"  media="screen,projection"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            margin:40px auto;
            line-height:1.6;
            font-size:18px;
            font-family: Inconsolata, monospace;
            color:#444;
            padding:0 10px;
            font-weight: 400;
            line-height: 24px;
        }
        h1,h2,h3 {
            line-height:1.2;
            color:#333;
            text-align: left;
        }
        a {
            text-decoration: none;
        }
        a:link {
            color: black;
        }
        a:visited {
            color: black;
        }
        a:active {
            color: black;
        }
        a:hover {
            color: blue;
            border-bottom:1px dotted black;
        }
        .CodeMirror {
            border-top: 1px solid black;
            border-bottom: 1px solid black;
        }
        #resultstable {
            font-size: 12px;
        }
        .listhighlight:hover {
            background-color: #eee;
        }
        .listhighlight {
            color: black;
        }
        .row {
            padding-left: 50px;
        }
    </style>
  	<title>HodDB Query</title>
  </head>
  <body>
    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="static/js/materialize.min.js"></script>
    <div class="container">
      <div>
        <ul id="slide-out" style="width:350px" class="side-nav fixed blue lighten-5">
            <li><h3>HodDB Query</h3></li>
            <li><a href="#">Query<i class="material-icons">keyboard_arrow_right</i></a></li>
            <li><a href="#">Visualize<i class="material-icons">keyboard_arrow_right</i></a></li>
            <li><a href="#">Documentation<i class="material-icons">keyboard_arrow_right</i></a></li>
            <li><hr></li>
            <li><h5>Common Queries</h5></li>
            <li class="collection-item"><a id="query_vavselect" class="listhighlight">VAV Select<i class="material-icons">code</i></a><li>
            <li class="collection-item"><a id="query_tempselect" class="listhighlight">Zone Temperature Sensors<i class="material-icons">code</i></a><li>
            <li class="collection-item"><a id="query_vavcmd" class="listhighlight">VAV Commands<i class="material-icons">code</i></a><li>
            <li class="collection-item"><a id="query_floors" class="listhighlight">Spatial Building Structure<i class="material-icons">code</i></a><li>
        </ul>
      </div>
      <div class="row">
        <div class="input-field col s2">
          <button class="btn waves-effect waves-light green" form="queryform" type="submit" name="action">Run Query</button>
        </div>
        <div class="col s2">
          <p>
            <input type="checkbox" class="filled-in" id="fullURI"/>
            <label for="fullURI">Full URI</label>
          </p>
        </div>
        <div class="col s2">
          <p>
            <input type="checkbox" class="filled-in" id="showJSON" />
            <label for="showJSON">Show JSON</label>
          </p>
        </div>
      </div>

      <div class="row">
        <div class="col s12">
          <form id="queryform" form="queryform" class="col s12">
            <textarea id="queryarea" name="queryarea">
SELECT ?vav WHERE {
    ?vav rdf:type brick:VAV .
};</textarea>
          </form>
        </div>
        <div class="row">
          <div id="errortext" class="col s12 card-panel red lighten-2" hidden>
          <p></p>
          </div>
        </div>
      </div>
      <div class="row">
        <h4 id="resultsheader" class="col s12" hidden>Results</h4>
        <div class="col s12" id="elapsed">
        </div>
        <div class="col s12">
          <table class="highlight bordered" id="resultstable"></table>
        </div>
        <div class="col s12" id="resultsjson">
        </div>
      </div>
    </div>
    <script type="text/javascript">
          var textarea = document.getElementById("queryarea");
          var cm = CodeMirror.fromTextArea(textarea, {
            mode:  "application/sparql-query",
            matchBrackets: true,
            lineNumbers: true
          });
          cm.refresh();

          var submit_query = function(query) {
            $("#errortext").hide();
            $("#resultsjson").hide();
            $("#resultstable").hide();
            var useFullURI = $("#fullURI")[0].checked;
            var showJSON = $("#showJSON")[0].checked;
            var html = "";
            var begin = moment();
            $.post("/api/query", query, function(data) {
                var end = moment();
                var duration = moment.duration(end - begin);
                $("#elapsed").text(duration.milliseconds() + " ms");
                $("#resultsheader").show();
                if (showJSON) {
                    $("#resultsjson").show();
                    html = "<code>" + JSON.stringify(data) + "</code>";
                    $("#resultsjson").html(html);
                } else if (data.Rows.length > 0) {
                    $("#resultstable").show();
                    var firstrow = data.Rows[0];
                    html += "<thead><tr>";
                    for (var key in firstrow) {
                        html += "<td><b>" + key + "</b></td>";
                    }
                    html += "</tr></thead><tbody>";
                    data.Rows.forEach(function(element) {
                        html += "<tr>"
                        for (var key in element) {
                            if (useFullURI) {
                                var newstuff = element[key].Namespace + "#" + element[key].Value;
                            } else {
                                var newstuff = element[key].Value;
                            }
                            html += "<td>" + newstuff + "</td>"
                        }
                        html += "</tr>"
                    });
                    html += "</tbody>";
                    $("#resultstable").html(html);
                }
            }).fail(function(e) {
                $("#errortext").show();
                $("#errortext > p").text(e.responseText);
            });
          }

          // init collapsible parts
          $('.collapsible').collapsible();

          // handle querying
          $("#queryform").submit(function(event) {
            var querytext = $("#queryarea").val();
            submit_query(querytext);
            event.preventDefault();
          });

          $("#query_vavselect").click(function(event) {
            cm.setValue("SELECT ?vav WHERE {\n\t?vav rdf:type brick:VAV .\n};");
            cm.setSize("100%", Math.max(300, cm.lineCount()*25));
            event.preventDefault();
          });
          $("#query_tempselect").click(function(event) {
            cm.setValue("SELECT ?sensor ?room\nWHERE {\n\t?sensor rdf:type/rdfs:subClassOf* brick:Zone_Temperature_Sensor .\n\t?room rdf:type brick:Room .\n\t?vav rdf:type brick:VAV .\n\t?zone rdf:type brick:HVAC_Zone .\n\n\t?vav bf:feeds+ ?zone .\n\t?zone bf:hasPart ?room .\n\t{\n\t\t?sensor bf:isPointOf ?vav .\n\t\tOR\n\t\t?sensor bf:isPointOf ?room . \n\t}\n};");
            cm.setSize("100%", Math.max(300, cm.lineCount()*25));
            cm.refresh();
            event.preventDefault();
          });
          $("#query_vavcmd").click(function(event) {
            cm.setValue("SELECT ?vlv_cmd ?vav\nWHERE {\n\t{\n\t\t?vlv_cmd rdf:type brick:Reheat_Valve_Command .\n\t\tOR\n\t\t?vlv_cmd rdf:type brick:Cooling_Valve_Command .\n\t}\n\t?vav rdf:type brick:VAV .\n\t?vav bf:hasPoint+ ?vlv_cmd .\n};");
            cm.setSize("100%", Math.max(300, cm.lineCount()*25));
            event.preventDefault();
          });
          $("#query_floors").click(function(event) {
            cm.setValue("SELECT ?floor ?room ?zone\nWHERE {\n\t?floor rdf:type brick:Floor .\n\t?room rdf:type brick:Room .\n\t?zone rdf:type brick:HVAC_Zone .\n\t?room bf:isPartOf+ ?floor .\n\t?room bf:isPartOf+ ?zone .\n};");
            cm.setSize("100%", Math.max(300, cm.lineCount()*25));
            event.preventDefault();
          });
    </script>
  </body>
</html>
