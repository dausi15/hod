<html>
  <head>
    <meta charset="utf-8">
    <script src="static/js/moment.js"></script>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="static/css/materialize.min.css"  media="screen,projection"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link type="text/css" rel="stylesheet" href="static/css/site.css" />
  	<title>HodDB Query</title>
    <ul id="slide-out" class="side-nav fixed blue lighten-5">
        <li><h3 class="center-align" !important>HodDB</h3></li>
        <li class="active"><a class="tooltipped" data-position="right" data-delay="100" data-tooltip="Execute BRICK queries" href="/query">Query<i class="material-icons">keyboard_arrow_right</i></a></li>
        <li><a class="tooltipped" data-position="right" data-delay="100" data-tooltip="Visualize the construction of BRICK queries" href="/plan">Planner<i class="material-icons">keyboard_arrow_right</i></a></li>
        <li><a class="tooltipped" data-position="right" data-delay="100" data-tooltip="Explore BRICK graphs" href="/explore">Explore<i class="material-icons">keyboard_arrow_right</i></a></li>
        <li class="active"><a class="tooltipped" data-position="right" data-delay="100" data-tooltip="Visualize the construction of BRICK queries" href="/search">Schema Search<i class="material-icons">keyboard_arrow_right</i></a></li>
        <li><a class="tooltipped" data-position="right" data-delay="100" data-tooltip="Documentation and other resources" href="/help">Help<i class="material-icons">keyboard_arrow_right</i></a></li>
        <li><div class="divider"></div></li>
    </ul>
    <a href="#" data-activates="slide-out" class="button-collapse"><i class="material-icons">menu</i></a>
  </head>
  <body>
    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="static/js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="static/js/materialize.min.js"></script>
    <main>
    <div class="container">
      <div class="row">
        <h5 class="col s12 center-align">Schema Search</h3>
      </div>

      <form id="queryform" form="queryform" class="col s12">
          <div class="row">
            <div class="col s12">
                <input type="text" id="searchtext" placeholder="static setpoint"></input>
            </div>
          </div>
          <div class="row">
            <div class="col s2">
                <input type="checkbox" id="uuid" class="filled-in" />
                <label for="uuid">UUID</label>
            </div>
            <div class="col s2">
                <input type="checkbox" id="uri" class="filled-in" />
                <label for="uri">URI</label>
            </div>
            <div class="col s2">
                <input type="checkbox" id="room" class="filled-in" />
                <label for="room">Room</label>
            </div>
            <div class="col s2">
                <input type="checkbox" id="HVACzone" class="filled-in" />
                <label for="HVACzone">HVAC Zone</label>
            </div>
            <div class="col s3">
                <input type="checkbox" id="Lightingzone" class="filled-in" />
                <label for="Lightingzone">Lighting Zone</label>
            </div>
          </div>
      </form>
      <div class="row">
        <div id="errortext" class="col s12 card-panel red lighten-2" hidden>
        <p></p>
        </div>
      </div>
      <div class="row">
        <h4 id="resultsheader" class="col s12" hidden>Results</h4>
        <div class="col s12">
          <table class="highlight bordered" id="resultstable"></table>
        </div>
        <div class="col s12" id="resultsjson">
        </div>
      </div>
    </div>
    </main>
    <script type="text/javascript">
          var textarea = document.getElementById("searchtext");

          var submit_query = function(query) {
            $("#resultstable").hide();
            $("#errortext").hide();
            var html = "<thead><th>URI</th></thead><tbody>";

            $.post("/api/search", JSON.stringify(query), function(data) {
                var url = new URL(window.document.location);
                url.searchParams.set("query", query.Query);
                // replace URL without reloading
                history.pushState(null,null,url);

                if (data == null) {
                    $("#errortext").show();
                    $("#errortext > p").text("No results");
                } else {
                    $("#resultstable").show();
                    //var querystring = "SELECT+%3Fx+WHERE+%7B%0A++++%3Fx+rdf%3Atype%2Frdfs%3AsubClassOf*+"+element+"+.";
                    var selectvars = "?x"
                    var whereparams = "";
                    if ($("#uuid").prop("checked")) {
                        whereparams += "?x bf:uuid ?uuid .\n"
                        selectvars += " ?uuid"
                    }
                    if ($("#uri").prop("checked")) {
                        whereparams += "?x bf:uri ?uri .\n"
                        selectvars += " ?uri"
                    }
                    if ($("#room").prop("checked")) {
                        whereparams += "?x bf:isLocatedIn ?room . \n?room rdf:type brick:Room .\n"
                        selectvars += " ?room"
                        console.log("room");
                    }
                    if ($("#HVACzone").prop("checked")) {
                        whereparams += "?x bf:isLocatedIn/bf:isPartOf ?hvaczone .\n ?hvaczone rdf:type brick:HVAC_Zone .\n"
                        selectvars += " ?hvaczone"
                    }
                    if ($("#Lightingzone").prop("checked")) {
                        whereparams += "?x bf:isLocatedIn/bf:isPartOf ?lightingzone .\n ?lightingzone rdf:type brick:lighting_Zone .\n"
                        selectvars += " ?lightingzone"
                    }


                    data.forEach(function(element) {
                        var querystring = "SELECT " + selectvars + " WHERE { \n" + whereparams;
                        querystring += "?x rdf:type/rdfs:subClassOf* "+element+" .\n";
                        querystring += "};";
                        html += "<tr><td>"
                        html += "<a href='/query?query="+encodeURIComponent(querystring)+"'>" + element + "</a>";
                        //html += "<a href='/query?query=SELECT+%3Fx+WHERE+%7B%0A++++%3Fx+rdf%3Atype%2Frdfs%3AsubClassOf*+"+element+"+.%0A%7D%3B'>"+element+"</a>";
                        html += "</td></tr>"
                    });
                    html += "</tbody>";
                    $("#resultstable").html(html);
                }
            }).fail(function(e) {
                $("#errortext").show();
                $("#errortext > p").text(e.responseText);
            });
          }
          var url = new URL(window.document.location);
          var query = url.searchParams.get("query");
          if (query != null) {
              $("#searchtext").val(query);
              submit_query({'Query':query, 'Number': 500});
          }

          // init collapsible parts
          $('.collapsible').collapsible();

          $('.button-collapse').sideNav({
            menuWidth: 350, // Default is 240
            }
          );

          // handle querying
          //$("#searchtext").on("input", function(event) {
          //  var querytext = $(this).val();
          //  submit_query({'Query':querytext, 'Number': 500});
          //  event.preventDefault();
          //});
          $("form :input").change(function() {
            var querytext = $("#searchtext").val();
            submit_query({'Query':querytext, 'Number': 500});
            event.preventDefault();
          });
          $("#queryform").submit(function(event) {
            var querytext = $("#searchtext").val();
            submit_query({'Query':querytext, 'Number': 500});
            event.preventDefault();
          });
    </script>
  </body>
</html>
